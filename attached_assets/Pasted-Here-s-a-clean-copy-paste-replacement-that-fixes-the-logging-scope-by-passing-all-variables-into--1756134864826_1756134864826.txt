Here’s a clean, copy-paste replacement that fixes the logging scope by **passing all variables into `write_log`**.

CREATE OR REPLACE PROCEDURE `media-455519.mediatracker.process_new_url`()
OPTIONS(strict\_mode = FALSE)
BEGIN
\-- session
DECLARE run\_id STRING DEFAULT GENERATE\_UUID();
DECLARE proc\_name STRING DEFAULT 'process\_new\_url';
DECLARE start\_ts TIMESTAMP DEFAULT CURRENT\_TIMESTAMP();

\-- working state
DECLARE target\_id INT64;
DECLARE target\_url STRING;
DECLARE content\_len INT64;
DECLARE cleaned STRING;
DECLARE norm\_domain STRING;

\-- logger UDF (avoid clash with LOG and pass vars explicitly)
CREATE TEMP FUNCTION write\_log(
step STRING, sev STRING, msg STRING, ctx JSON,
run\_id\_param STRING, target\_url\_param STRING, proc\_name\_param STRING, start\_ts\_param TIMESTAMP
)
AS (STRUCT(
run\_id\_param AS run\_id,
COALESCE(target\_url\_param, '') AS url,
proc\_name\_param AS proc,
step AS step,
sev AS severity,
msg AS message,
ctx AS context,
TIMESTAMP\_DIFF(CURRENT\_TIMESTAMP(), start\_ts\_param, MILLISECOND) AS ms\_elapsed,
CURRENT\_TIMESTAMP() AS ts
));

/\* START \*/
INSERT INTO `media-455519.mediatracker.processing_logs`
(run\_id,url,proc,step,severity,message,context,ms\_elapsed,ts)
SELECT \* FROM UNNEST(\[
write\_log('START','INFO','begin', TO\_JSON(STRUCT()),
run\_id, target\_url, proc\_name, start\_ts)
]);

/\* STEP 1: pick newest row \*/
BEGIN
SET target\_url = (
SELECT url
FROM `media-455519.mediatracker.mediatracker`
WHERE url IS NOT NULL AND TRIM(url) <> ''
ORDER BY updated\_at DESC
LIMIT 1
);

```
INSERT INTO `media-455519.mediatracker.processing_logs`
(run_id,url,proc,step,severity,message,context,ms_elapsed,ts)
SELECT * FROM UNNEST([
  write_log('SELECT_NEWEST','INFO',IFNULL(target_url,'<null>'), TO_JSON(STRUCT()),
            run_id, target_url, proc_name, start_ts)
]);

IF target_url IS NULL THEN
  INSERT INTO `media-455519.mediatracker.processing_logs`
  (run_id,url,proc,step,severity,message,context,ms_elapsed,ts)
  SELECT * FROM UNNEST([
    write_log('EXIT','WARN','no rows in mediatracker', TO_JSON(STRUCT()),
              run_id, target_url, proc_name, start_ts)
  ]);
  RETURN;
END IF;
```

EXCEPTION WHEN ERROR THEN
INSERT INTO `media-455519.mediatracker.processing_logs`
(run\_id,url,proc,step,severity,message,context,ms\_elapsed,ts)
SELECT \* FROM UNNEST(\[
write\_log('SELECT\_NEWEST','ERROR', ERROR\_MESSAGE(), TO\_JSON(STRUCT()),
run\_id, target\_url, proc\_name, start\_ts)
]);
RETURN;
END;

/\* STEP 2: assign id (if missing) + resolve id \*/
BEGIN
UPDATE `media-455519.mediatracker.mediatracker`
SET id = (SELECT IFNULL(MAX(id),0) + 1 FROM `media-455519.mediatracker.mediatracker`)
WHERE id IS NULL AND LOWER(TRIM(url)) = LOWER(TRIM(target\_url));

```
SET target_id = (
  SELECT id
  FROM `media-455519.mediatracker.mediatracker`
  WHERE LOWER(TRIM(url)) = LOWER(TRIM(target_url))
  ORDER BY updated_at DESC
  LIMIT 1
);

INSERT INTO `media-455519.mediatracker.processing_logs`
(run_id,url,proc,step,severity,message,context,ms_elapsed,ts)
SELECT * FROM UNNEST([
  write_log('ASSIGN_ID','INFO','resolved id', TO_JSON(STRUCT(target_id AS id)),
            run_id, target_url, proc_name, start_ts)
]);

IF target_id IS NULL THEN
  INSERT INTO `media-455519.mediatracker.processing_logs`
  (run_id,url,proc,step,severity,message,context,ms_elapsed,ts)
  SELECT * FROM UNNEST([
    write_log('EXIT','WARN','could not resolve id after assign', TO_JSON(STRUCT()),
              run_id, target_url, proc_name, start_ts)
  ]);
  RETURN;
END IF;
```

EXCEPTION WHEN ERROR THEN
INSERT INTO `media-455519.mediatracker.processing_logs`
(run\_id,url,proc,step,severity,message,context,ms\_elapsed,ts)
SELECT \* FROM UNNEST(\[
write\_log('ASSIGN\_ID','ERROR', ERROR\_MESSAGE(), TO\_JSON(STRUCT()),
run\_id, target\_url, proc\_name, start\_ts)
]);
RETURN;
END;

/\* STEP 3: normalize core fields */
BEGIN
SET cleaned = REGEXP\_REPLACE(
REGEXP\_REPLACE(REGEXP\_REPLACE(LOWER(TRIM(target\_url)), r'^https?://([www](http://www).)?', ''), r'?.*\$', ''),
r'/\$', ''
);

```
SET norm_domain = (
  SELECT COALESCE(
           LOWER(NULLIF(TRIM(domain),'')),
           REGEXP_EXTRACT(LOWER(TRIM(target_url)), r'^https?://(?:www\.)?([^/]+)')
         )
  FROM `media-455519.mediatracker.mediatracker`
  WHERE id = target_id
);

UPDATE `media-455519.mediatracker.mediatracker`
SET
  cleaned_url  = COALESCE(cleaned_url, cleaned),
  domain       = COALESCE(domain, norm_domain),
  publish_date = COALESCE(publish_date, DATE(CURRENT_TIMESTAMP())),
  month        = COALESCE(month, DATE_TRUNC(DATE(COALESCE(publish_date, DATE(CURRENT_TIMESTAMP()))), MONTH)),
  language     = COALESCE(language,
                    CASE WHEN REGEXP_CONTAINS(IFNULL(content,''), r'[\p{Han}]') THEN 'zh' ELSE 'en' END),
  antler_in_headline = COALESCE(antler_in_headline,
                      REGEXP_CONTAINS(LOWER(IFNULL(title,'')), r'\bantler\b')),
  tagged_antler = COALESCE(tagged_antler,
                    REGEXP_CONTAINS(LOWER(IFNULL(content,'')), r'\bantler\b') OR
                    REGEXP_CONTAINS(LOWER(IFNULL(title,'')), r'\bantler\b') OR
                    LOWER(IFNULL(managed_by_fund,'')) = 'antler'),
  updated_at = CURRENT_TIMESTAMP()
WHERE id = target_id;

INSERT INTO `media-455519.mediatracker.processing_logs`
(run_id,url,proc,step,severity,message,context,ms_elapsed,ts)
SELECT * FROM UNNEST([
  write_log('NORMALIZE','INFO','normalized',
    TO_JSON(STRUCT(
      (SELECT cleaned_url FROM `media-455519.mediatracker.mediatracker` WHERE id=target_id) AS cleaned_url,
      (SELECT domain      FROM `media-455519.mediatracker.mediatracker` WHERE id=target_id) AS domain,
      (SELECT language    FROM `media-455519.mediatracker.mediatracker` WHERE id=target_id) AS language
    )),
    run_id, target_url, proc_name, start_ts)
]);
```

EXCEPTION WHEN ERROR THEN
INSERT INTO `media-455519.mediatracker.processing_logs`
(run\_id,url,proc,step,severity,message,context,ms\_elapsed,ts)
SELECT \* FROM UNNEST(\[
write\_log('NORMALIZE','ERROR', ERROR\_MESSAGE(), TO\_JSON(STRUCT()),
run\_id, target\_url, proc\_name, start\_ts)
]);
\-- continue
END;

/\* STEP 4: content guard \*/
BEGIN
SET content\_len = (
SELECT LENGTH(TRIM(IFNULL(content,'')))
FROM `media-455519.mediatracker.mediatracker`
WHERE id = target\_id
);

```
INSERT INTO `media-455519.mediatracker.processing_logs`
(run_id,url,proc,step,severity,message,context,ms_elapsed,ts)
SELECT * FROM UNNEST([
  write_log('GUARD_CONTENT','INFO','content length', TO_JSON(STRUCT(content_len AS len)),
            run_id, target_url, proc_name, start_ts)
]);

IF content_len < 20 THEN
  INSERT INTO `media-455519.mediatracker.processing_logs`
  (run_id,url,proc,step,severity,message,context,ms_elapsed,ts)
  SELECT * FROM UNNEST([
    write_log('SKIP','WARN','content too short (<20)', TO_JSON(STRUCT(target_id AS id)),
              run_id, target_url, proc_name, start_ts)
  ]);
  RETURN;
END IF;
```

EXCEPTION WHEN ERROR THEN
INSERT INTO `media-455519.mediatracker.processing_logs`
(run\_id,url,proc,step,severity,message,context,ms\_elapsed,ts)
SELECT \* FROM UNNEST(\[
write\_log('GUARD\_CONTENT','ERROR', ERROR\_MESSAGE(), TO\_JSON(STRUCT()),
run\_id, target\_url, proc\_name, start\_ts)
]);
RETURN;
END;

/\* STEP 5: spokespeople \*/
BEGIN
MERGE `media-455519.mediatracker.mediatracker` AS m
USING (
SELECT m.id, STRING\_AGG(DISTINCT sp.spokesperson\_name, ', ') AS spokes
FROM `media-455519.mediatracker.mediatracker` m
JOIN `media-455519.mediatracker.spokespeople` sp
ON REGEXP\_CONTAINS(' ' || LOWER(IFNULL(m.content,'')) || ' ',
r'\[^a-z0-9]' || LOWER(sp.spokesperson\_name) || r'\[^a-z0-9]')
WHERE m.id = target\_id
GROUP BY m.id
) s
ON m.id = s.id
WHEN MATCHED AND s.spokes IS NOT NULL AND s.spokes <> '' THEN
UPDATE SET matched\_spokespeople = s.spokes;

```
INSERT INTO `media-455519.mediatracker.processing_logs`
(run_id,url,proc,step,severity,message,context,ms_elapsed,ts)
SELECT * FROM UNNEST([
  write_log('ENRICH_SPOKES','INFO','done',
    TO_JSON(STRUCT((SELECT matched_spokespeople FROM `media-455519.mediatracker.mediatracker` WHERE id=target_id) AS matched_spokespeople)),
    run_id, target_url, proc_name, start_ts)
]);
```

EXCEPTION WHEN ERROR THEN
INSERT INTO `media-455519.mediatracker.processing_logs`
(run\_id,url,proc,step,severity,message,context,ms\_elapsed,ts)
SELECT \* FROM UNNEST(\[
write\_log('ENRICH\_SPOKES','ERROR', ERROR\_MESSAGE(), TO\_JSON(STRUCT()),
run\_id, target\_url, proc\_name, start\_ts)
]);
END;

/\* STEP 6: headline flag \*/
BEGIN
UPDATE `media-455519.mediatracker.mediatracker`
SET spokespeople\_in\_headline = EXISTS (
SELECT 1
FROM `media-455519.mediatracker.spokespeople` sp
WHERE REGEXP\_CONTAINS(' ' || LOWER(IFNULL(title,'')) || ' ',
r'\[^a-z0-9]' || LOWER(sp.spokesperson\_name) || r'\[^a-z0-9]')
)
WHERE id = target\_id;
EXCEPTION WHEN ERROR THEN
INSERT INTO `media-455519.mediatracker.processing_logs`
(run\_id,url,proc,step,severity,message,context,ms\_elapsed,ts)
SELECT \* FROM UNNEST(\[
write\_log('HEADLINE\_FLAG','ERROR', ERROR\_MESSAGE(), TO\_JSON(STRUCT()),
run\_id, target\_url, proc\_name, start\_ts)
]);
END;

/\* STEP 7: VC investors \*/
BEGIN
MERGE `media-455519.mediatracker.mediatracker` AS m
USING (
SELECT m.id,
STRING\_AGG(DISTINCT vc.investor, ', ') AS investors,
STRING\_AGG(DISTINCT CAST(vc.rank AS STRING), ', ') AS ranks
FROM `media-455519.mediatracker.mediatracker` m
JOIN `media-455519.mediatracker.vc_investor_rankings` vc
ON REGEXP\_CONTAINS(' ' || LOWER(IFNULL(m.content,'')) || ' ',
r'\[^a-z0-9]' || LOWER(vc.investor) || r'\[^a-z0-9]')
WHERE m.id = target\_id
GROUP BY m.id
) v
ON m.id = v.id
WHEN MATCHED AND v.investors IS NOT NULL AND v.investors <> '' THEN
UPDATE SET matched\_vc\_investors = v.investors,
matched\_dealroom\_rank = v.ranks;

```
INSERT INTO `media-455519.mediatracker.processing_logs`
(run_id,url,proc,step,severity,message,context,ms_elapsed,ts)
SELECT * FROM UNNEST([
  write_log('ENRICH_INVESTORS','INFO','done',
    TO_JSON(STRUCT(
      (SELECT matched_vc_investors FROM `media-455519.mediatracker.mediatracker` WHERE id=target_id) AS matched_vc_investors,
      (SELECT matched_dealroom_rank FROM `media-455519.mediatracker.mediatracker` WHERE id=target_id) AS matched_dealroom_rank
    )),
    run_id, target_url, proc_name, start_ts)
]);
```

EXCEPTION WHEN ERROR THEN
INSERT INTO `media-455519.mediatracker.processing_logs`
(run\_id,url,proc,step,severity,message,context,ms\_elapsed,ts)
SELECT \* FROM UNNEST(\[
write\_log('ENRICH\_INVESTORS','ERROR', ERROR\_MESSAGE(), TO\_JSON(STRUCT()),
run\_id, target\_url, proc\_name, start\_ts)
]);
END;

/\* STEP 8: reporters \*/
BEGIN
MERGE `media-455519.mediatracker.mediatracker` AS m
USING (
SELECT m.id, STRING\_AGG(DISTINCT r.tagged\_reporter, ', ') AS reporters
FROM `media-455519.mediatracker.mediatracker` m
JOIN `media-455519.mediatracker.reporters` r
ON REGEXP\_CONTAINS(' ' || LOWER(IFNULL(m.content,'')) || ' ',
r'\[^a-z0-9]' || LOWER(r.tagged\_reporter) || r'\[^a-z0-9]')
WHERE m.id = target\_id
GROUP BY m.id
) rr
ON m.id = rr.id
WHEN MATCHED AND rr.reporters IS NOT NULL AND rr.reporters <> '' THEN
UPDATE SET matched\_reporter = rr.reporters;

```
INSERT INTO `media-455519.mediatracker.processing_logs`
(run_id,url,proc,step,severity,message,context,ms_elapsed,ts)
SELECT * FROM UNNEST([
  write_log('ENRICH_REPORTERS','INFO','done',
    TO_JSON(STRUCT((SELECT matched_reporter FROM `media-455519.mediatracker.mediatracker` WHERE id=target_id) AS matched_reporter)),
    run_id, target_url, proc_name, start_ts)
]);
```

EXCEPTION WHEN ERROR THEN
INSERT INTO `media-455519.mediatracker.processing_logs`
(run\_id,url,proc,step,severity,message,context,ms\_elapsed,ts)
SELECT \* FROM UNNEST(\[
write\_log('ENRICH\_REPORTERS','ERROR', ERROR\_MESSAGE(), TO\_JSON(STRUCT()),
run\_id, target\_url, proc\_name, start\_ts)
]);
END;

/\* STEP 9: portcos + tagged\_portco \*/
BEGIN
MERGE `media-455519.mediatracker.mediatracker` AS m
USING (
SELECT m.id,
STRING\_AGG(DISTINCT p.portco\_name, ', ') AS portcos,
STRING\_AGG(DISTINCT p.portco\_location, ', ') AS locations,
STRING\_AGG(DISTINCT p.portco\_deal\_lead, ', ') AS leads,
STRING\_AGG(DISTINCT p.ai, ', ') AS ai
FROM `media-455519.mediatracker.mediatracker` m
JOIN `media-455519.mediatracker.portcos` p
ON REGEXP\_CONTAINS(' ' || LOWER(IFNULL(m.content,'')) || ' ',
r'\[^a-z0-9]' || LOWER(p.portco\_name) || r'\[^a-z0-9]')
WHERE m.id = target\_id
GROUP BY m.id
) pc
ON m.id = pc.id
WHEN MATCHED AND pc.portcos IS NOT NULL AND pc.portcos <> '' THEN
UPDATE SET
matched\_portcos = pc.portcos,
matched\_portco\_location = pc.locations,
matched\_portco\_deal\_lead = pc.leads,
matched\_portco\_ai = pc.ai;

```
UPDATE `media-455519.mediatracker.mediatracker`
SET tagged_portco = (matched_portcos IS NOT NULL AND matched_portcos <> '')
WHERE id = target_id;

INSERT INTO `media-455519.mediatracker.processing_logs`
(run_id,url,proc,step,severity,message,context,ms_elapsed,ts)
SELECT * FROM UNNEST([
  write_log('ENRICH_PORTCOS','INFO','done',
    TO_JSON(STRUCT((SELECT matched_portcos FROM `media-455519.mediatracker.mediatracker` WHERE id=target_id) AS matched_portcos)),
    run_id, target_url, proc_name, start_ts)
]);
```

EXCEPTION WHEN ERROR THEN
INSERT INTO `media-455519.mediatracker.processing_logs`
(run\_id,url,proc,step,severity,message,context,ms\_elapsed,ts)
SELECT \* FROM UNNEST(\[
write\_log('ENRICH\_PORTCOS','ERROR', ERROR\_MESSAGE(), TO\_JSON(STRUCT()),
run\_id, target\_url, proc\_name, start\_ts)
]);
END;

/\* STEP 10: keyword flags \*/
BEGIN
UPDATE `media-455519.mediatracker.mediatracker`
SET
kill\_pill = REGEXP\_CONTAINS(LOWER(IFNULL(content,'')), r'\b(incubator|孵化器|孵化场|孵化中心)\b'),
kill\_pill\_count = ARRAY\_LENGTH(REGEXP\_EXTRACT\_ALL(LOWER(IFNULL(content,'')), r'\b(incubator|孵化器|孵化场|孵化中心)\b')),
kill\_pill\_context = (
SELECT STRING\_AGG(sentence, ' | ')
FROM UNNEST(SPLIT(IFNULL(content,''), '.')) AS sentence
WHERE REGEXP\_CONTAINS(LOWER(sentence), r'\b(incubator|孵化器|孵化场|孵化中心)\b')
),
unwanted = REGEXP\_CONTAINS(LOWER(IFNULL(content,'')), r'\b(accelerator|startup factory|孵化器工厂)\b'),
unwanted\_count = ARRAY\_LENGTH(REGEXP\_EXTRACT\_ALL(LOWER(IFNULL(content,'')), r'\b(accelerator|startup factory|孵化器工厂)\b')),
unwanted\_context = (
SELECT STRING\_AGG(sentence, ' | ')
FROM UNNEST(SPLIT(IFNULL(content,''), '.')) AS sentence
WHERE REGEXP\_CONTAINS(LOWER(sentence), r'\b(accelerator|startup factory|孵化器工厂)\b')
)
WHERE id = target\_id;

```
INSERT INTO `media-455519.mediatracker.processing_logs`
(run_id,url,proc,step,severity,message,context,ms_elapsed,ts)
SELECT * FROM UNNEST([
  write_log('KEYWORDS','INFO','done', TO_JSON(STRUCT()),
            run_id, target_url, proc_name, start_ts)
]);
```

EXCEPTION WHEN ERROR THEN
INSERT INTO `media-455519.mediatracker.processing_logs`
(run\_id,url,proc,step,severity,message,context,ms\_elapsed,ts)
SELECT \* FROM UNNEST(\[
write\_log('KEYWORDS','ERROR', ERROR\_MESSAGE(), TO\_JSON(STRUCT()),
run\_id, target\_url, proc\_name, start\_ts)
]);
END;

/\* STEP 11: media metadata \*/
BEGIN
MERGE `media-455519.mediatracker.mediatracker` AS m
USING (
SELECT m.id, d.country, d.page\_rank, d.tier
FROM `media-455519.mediatracker.mediatracker` m
JOIN `media-455519.mediatracker.media_data` d
ON LOWER(REPLACE(IFNULL(m.domain,''),'[www](http://www).','')) = LOWER(REPLACE(d.domain,'[www](http://www).',''))
WHERE m.id = target\_id
) md
ON m.id = md.id
WHEN MATCHED THEN
UPDATE SET
m.country   = IFNULL(m.country, md.country),
m.page\_rank = IFNULL(m.page\_rank, md.page\_rank),
m.tier      = IFNULL(m.tier, md.tier);

```
INSERT INTO `media-455519.mediatracker.processing_logs`
(run_id,url,proc,step,severity,message,context,ms_elapsed,ts)
SELECT * FROM UNNEST([
  write_log('MEDIA_META','INFO','done',
    TO_JSON(STRUCT((SELECT country FROM `media-455519.mediatracker.mediatracker` WHERE id=target_id) AS country)),
    run_id, target_url, proc_name, start_ts)
]);
```

EXCEPTION WHEN ERROR THEN
INSERT INTO `media-455519.mediatracker.processing_logs`
(run\_id,url,proc,step,severity,message,context,ms\_elapsed,ts)
SELECT \* FROM UNNEST(\[
write\_log('MEDIA\_META','ERROR', ERROR\_MESSAGE(), TO\_JSON(STRUCT()),
run\_id, target\_url, proc\_name, start\_ts)
]);
END;

/\* DONE \*/
INSERT INTO `media-455519.mediatracker.processing_logs`
(run\_id,url,proc,step,severity,message,context,ms\_elapsed,ts)
SELECT \* FROM UNNEST(\[
write\_log('DONE','INFO','completed', TO\_JSON(STRUCT(target\_id AS id)),
run\_id, target\_url, proc\_name, start\_ts)
]);

END;
